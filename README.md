# Сжимальщик видео

Веб-приложение на Flask для автоматического удаления «застывших» фрагментов из видео и последующей склейки оставшихся частей без чёрных провалов (мягкий crossfade или жёсткий cut). Выходной формат — MP4 (H.264 + AAC).

## 1. Описание, возможности и ограничения

**Возможности**
- Поиск статичных участков по перцептуальному хэшу (pHash) на даунскейленных кадрах и пониженном FPS анализа.
- Гибкая настройка детектора: чувствительность, размер окна, минимальные длительности, объединение соседних сцен, «запас» по краям и т. д.
- Два типа переходов:
  - **Crossfade** — мягкая склейка без чёрного экрана.
  - **Cut** — мгновенная склейка (опционально можно задать короткий fade).
- Контроль выходного FPS, качества кодирования (CRF) и пресета (скорость/эффективность).
- Безопасная загрузка: ограничение размера, белый список расширений, уникальные имена файлов.
- Понятные логи + вывод stderr из ffmpeg/ffprobe при ошибках.

**Ограничения**
- Выход всегда MP4 (H.264,yuv420p) + AAC.
- Анализ выполняется на пониженной ширине кадра (по умолчанию 320 px) и ограниченном FPS (≈ до 15) — это ускоряет вычисления и не влияет на качество итогового видео.
- Слишком короткие сцены могут частично перекрываться кросс-фейдом; длительность перехода автоматически подрезается, но не меньше 0.02 с.
- Для локального запуска требуется установленный `ffmpeg`. В Docker-образ он включён.

## 2. Системные требования

**Вариант A — Docker (рекомендуется)**
- Docker 20.10+
- Доступ к реестру git.miem.hse.ru для загрузки/выгрузки образа

**Вариант B — Локально**
- Python 3.11+
- FFmpeg/FFprobe в PATH
- Зависимости из requirements.txt

Рекомендуемые ресурсы: многоядерный CPU, ≥2–4 ГБ RAM, достаточно диска для `uploads/` и `outputs/`.

## 3. Запуск и загрузка данных

### 3.1. Запуск через Docker

Сборка образа:
bash
docker build -t video-compressor:latest .


Запуск:
bash
docker run --rm -p 5000:5000   -e MAX_SIZE_GB=2   -e LOG_LEVEL=INFO   -v "$PWD/uploads:/app/uploads"   -v "$PWD/outputs:/app/outputs"   video-compressor:latest

Открыть в браузере: http://localhost:5000

Публикация в реестр MIEM (заменить <group> и <project>):
bash
docker tag video-compressor:latest registry.git.miem.hse.ru/<group>/<project>:v1
docker login registry.git.miem.hse.ru
docker push registry.git.miem.hse.ru/<group>/<project>:v1

> Проверка на стороне MIEM запускает **именно Docker Image**, а не код из репозитория. Убедитесь, что образ корректно собирается и стартует.

### 3.2. Локальный запуск

Установить FFmpeg, затем:
bash
python -m venv .venv
. .venv/bin/activate        # Windows: .venv\Scripts\activate
pip install -r requirements.txt
export MAX_SIZE_GB=2 LOG_LEVEL=INFO
python app.py
# затем открыть http://localhost:5000

### 3.3. Загрузка данных

- Загружать видео через форму на главной странице.
- Поддерживаемые расширения: .mp4, .mov, .mkv, .avi, .m4v, .webm.
- Лимит размера задаётся переменной окружения MAX_SIZE_GB и (если используется) настройками реверс-прокси (client_max_body_size в nginx).

## 4. Задействованные инструменты

- **Backend:** Python, Flask  
- **Видео:** ffmpeg/ffprobe, ffmpeg-python  
- **Кадры/хэши:** Pillow, ImageHash (pHash), NumPy/ SciPy  
- **Шаблоны:** Jinja2 (через Flask)  
- **Формат вывода:** MP4 (H.264 + AAC)

## Переменные окружения

| Переменная   | По умолчанию | Назначение                                      |
|--------------|--------------|-------------------------------------------------|
|  UPLOAD_DIR  |  uploads     | Каталог для загруженных файлов                  |
|  OUTPUT_DIR  |   outputs    | Каталог для результатов                         |
|  LOG_LEVEL   |   INFO       | Уровень логирования (`DEBUG/INFO/WARNING/ERROR`)|
|  MAX_SIZE_GB |   2          | Лимит размера загружаемого файла (ГБ)           |


## Эндпоинты

- GET / — форма настроек и загрузки
- POST /upload — обработка видео, статистика и ссылки на результат
- GET /outputs/<filename> — просмотр результата
- GET /download/<filename> — скачивание результата

## Поля формы и диапазоны

**Файл и общий вывод**
- Частота кадров на выходе (FPS): **1–120**, по умолчанию — как в исходнике (пусто). Рекомендация: 25–30.

**Переходы**
- Тип: crossfade (по умолчанию) / cut
- Длительность crossfade (сек): **0.02–1.00**, по умолчанию **0.12**
- Запас по краям фрагментов (сек): **0.00–1.00**, по умолчанию **0.12**
- CRF: **10–40**, по умолчанию **22** (ниже — лучше качество, больше размер)
- Preset: от ultrafast до veryslow, по умолчанию fast
- Fade на сегментах (сек): **0.00–1.00**, по умолчанию **0.00** (актуально для cut)

**Детектор «застываний»**
- Ширина кадра для анализа (px): **64–1920**, по умолчанию **320**
- Процент «похожих» кадров: **0.50–1.00**, по умолчанию **0.85**
- Чувствительность к похожести: **1–64**, по умолчанию **6**
- Размер окна (кадров): **3–61**, по умолчанию **9**
- Мин. длительность «статичности» (сек): **0.20–10.00**, по умолчанию **0.70**
- Оставить по краям (сек): **0.00–2.00**, по умолчанию **0.25**
- Мин. длительность сохраняемого фрагмента (сек): **0.10–10.00**, по умолчанию **0.35**
- Объединять, если пауза меньше (сек): **0.00–2.00**, по умолчанию **0.05**
- FPS анализа: назначается автоматически (обычно ≤ 15) для ускорения

## Траблшутинг

- **HTTP 413 (слишком большой файл):** увеличить MAX_SIZE_GB; для nginx — client_max_body_size 2G;.
- **FFmpeg не найден:** установить в систему или использовать Docker-образ.
- **«Чёрные провалы» на стыках:** использовать crossfade с длительностью 0.10–0.15 с.
- **Удаляет лишнее / пропускает паузы:**  
  — удаляет лишнее: увеличить «Мин. длительность застывания» и/или «Оставить по краям»;  
  — пропускает паузы: уменьшить «Чувствительность к похожести» или увеличить «Процент похожих кадров».
- **Пустые логи:** запустить с LOG_LEVEL=DEBUG.

---
